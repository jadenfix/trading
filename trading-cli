#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

usage() {
  cat <<'EOF'
Usage:
  ./trading-cli <command> [args]

Commands:
  test [suite]                     Run tests from the repo root.
  bots [prod|dry-run|check-auth]   Run non-agent bots through run-bots.sh.
  help                             Show this help.

Test suites:
  all (default)
  common
  kalshi-client
  weather-bot
  arbitrage-bot

Examples:
  ./trading-cli test
  ./trading-cli test weather-bot
  ./trading-cli bots dry-run
EOF
}

run_step() {
  local label="$1"
  shift

  echo
  echo "==> $label"
  "$@"
}

test_common() {
  run_step \
    "common tests" \
    cargo test --manifest-path "$ROOT_DIR/non-agent-workflows/libs/common/Cargo.toml"
}

test_kalshi_client() {
  run_step \
    "kalshi-client tests" \
    cargo test --manifest-path "$ROOT_DIR/non-agent-workflows/libs/kalshi_client/Cargo.toml"
}

test_weather_bot() {
  run_step \
    "weather-bot workspace tests" \
    cargo test --manifest-path "$ROOT_DIR/non-agent-workflows/weather-bot/Cargo.toml" --workspace
}

test_arbitrage_bot() {
  run_step \
    "arbitrage-bot workspace tests" \
    cargo test --manifest-path "$ROOT_DIR/non-agent-workflows/arbitrage-bot/Cargo.toml" --workspace
}

run_tests() {
  local suite="${1:-all}"

  case "$suite" in
    all)
      test_common
      test_kalshi_client
      test_weather_bot
      test_arbitrage_bot
      ;;
    common)
      test_common
      ;;
    kalshi-client)
      test_kalshi_client
      ;;
    weather-bot)
      test_weather_bot
      ;;
    arbitrage-bot)
      test_arbitrage_bot
      ;;
    *)
      echo "Unknown test suite: $suite" >&2
      usage
      exit 1
      ;;
  esac
}

run_bots() {
  local mode="${1:-prod}"
  case "$mode" in
    prod|dry-run|check-auth) ;;
    *)
      echo "Invalid bots mode: $mode" >&2
      usage
      exit 1
      ;;
  esac

  exec "$ROOT_DIR/run-bots.sh" "$mode"
}

main() {
  local cmd="${1:-help}"
  shift || true

  case "$cmd" in
    test)
      run_tests "${1:-all}"
      ;;
    bots)
      run_bots "${1:-prod}"
      ;;
    help|-h|--help)
      usage
      ;;
    *)
      echo "Unknown command: $cmd" >&2
      usage
      exit 1
      ;;
  esac
}

main "$@"
