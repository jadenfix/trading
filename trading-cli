#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

usage() {
  cat <<'EOF'
Usage:
  ./trading-cli <command> [args]

Commands:
  test [suite]                     Run tests from the repo root.
  bots [prod|dry-run|check-auth]   Run non-agent bots through run-bots.sh.
  help                             Show this help.

Test suites:
  all (default)
  common
  kalshi-client
  weather-bot
  arbitrage-bot
  llm-rules-bot
  llm-candidate-engine
  llm-decision-engine
  llm-execution-engine
  llm-client
  llm-rules-bot-bin

Examples:
  ./trading-cli test
  ./trading-cli test weather-bot
  ./trading-cli bots dry-run
EOF
}

run_step() {
  local label="$1"
  shift

  echo
  echo "==> $label"
  "$@"
}

test_common() {
  run_step \
    "common tests" \
    cargo test --manifest-path "$ROOT_DIR/non-agent-workflows/libs/common/Cargo.toml"
}

test_kalshi_client() {
  run_step \
    "kalshi-client tests" \
    cargo test --manifest-path "$ROOT_DIR/non-agent-workflows/libs/kalshi_client/Cargo.toml"
}

test_weather_bot() {
  run_step \
    "weather-bot workspace tests" \
    cargo test --manifest-path "$ROOT_DIR/non-agent-workflows/weather-bot/Cargo.toml" --workspace
}

test_arbitrage_bot() {
  run_step \
    "arbitrage-bot workspace tests" \
    cargo test --manifest-path "$ROOT_DIR/non-agent-workflows/arbitrage-bot/Cargo.toml" --workspace
}

test_llm_rules_bot() {
  run_step \
    "llm-rules-bot workspace tests" \
    cargo test --manifest-path "$ROOT_DIR/llm-workflows/llm-rules-bot/Cargo.toml" --workspace
}

test_llm_candidate_engine() {
  run_step \
    "llm candidate-engine tests" \
    cargo test --manifest-path "$ROOT_DIR/llm-workflows/llm-rules-bot/crates/candidate-engine/Cargo.toml"
}

test_llm_decision_engine() {
  run_step \
    "llm decision-engine tests" \
    cargo test --manifest-path "$ROOT_DIR/llm-workflows/llm-rules-bot/crates/decision-engine/Cargo.toml"
}

test_llm_execution_engine() {
  run_step \
    "llm execution-engine tests" \
    cargo test --manifest-path "$ROOT_DIR/llm-workflows/llm-rules-bot/crates/execution-engine/Cargo.toml"
}

test_llm_client() {
  run_step \
    "llm client tests" \
    cargo test --manifest-path "$ROOT_DIR/llm-workflows/llm-rules-bot/crates/llm-client/Cargo.toml"
}

test_llm_rules_bot_bin() {
  run_step \
    "llm-rules-bot binary tests" \
    cargo test --manifest-path "$ROOT_DIR/llm-workflows/llm-rules-bot/Cargo.toml" --bin llm-rules-bot
}

run_tests() {
  local suite="${1:-all}"

  case "$suite" in
    all)
      test_common
      test_kalshi_client
      test_weather_bot
      test_arbitrage_bot
      test_llm_rules_bot
      test_llm_candidate_engine
      test_llm_decision_engine
      test_llm_execution_engine
      test_llm_client
      test_llm_rules_bot_bin
      ;;
    common)
      test_common
      ;;
    kalshi-client)
      test_kalshi_client
      ;;
    weather-bot)
      test_weather_bot
      ;;
    arbitrage-bot)
      test_arbitrage_bot
      ;;
    llm-rules-bot)
      test_llm_rules_bot
      ;;
    llm-candidate-engine)
      test_llm_candidate_engine
      ;;
    llm-decision-engine)
      test_llm_decision_engine
      ;;
    llm-execution-engine)
      test_llm_execution_engine
      ;;
    llm-client)
      test_llm_client
      ;;
    llm-rules-bot-bin)
      test_llm_rules_bot_bin
      ;;
    *)
      echo "Unknown test suite: $suite" >&2
      usage
      exit 1
      ;;
  esac
}

run_bots() {
  local mode="${1:-}"

  if [[ -z "$mode" ]]; then
    echo "Missing bots mode. Choose one of: prod | dry-run | check-auth" >&2
    usage
    exit 1
  fi

  case "$mode" in
    prod|dry-run|check-auth) ;;
    *)
      echo "Invalid bots mode: $mode" >&2
      usage
      exit 1
      ;;
  esac

  exec "$ROOT_DIR/run-bots.sh" "$mode"
}

main() {
  local cmd="${1:-help}"
  shift || true

  case "$cmd" in
    test)
      run_tests "${1:-all}"
      ;;
    bots)
      run_bots "${1:-}"
      ;;
    help|-h|--help)
      usage
      ;;
    *)
      echo "Unknown command: $cmd" >&2
      usage
      exit 1
      ;;
  esac
}

main "$@"
